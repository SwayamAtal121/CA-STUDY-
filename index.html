<!DOCTYPE html>
<html>
<head>
<title>CA Study Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* --- CSS STYLING --- */
*{box-sizing:border-box;}

body{
    font-family:'Inter',sans-serif;
    margin:0;
    background:linear-gradient(135deg,#020617,#0f172a);
    color:white;
    min-height: 100vh;
}

.app{
    max-width:1350px;
    margin:auto;
    padding:30px 18px;
}

h1{text-align:center;margin-bottom:18px;}

/* USER SWITCH */
.userSwitch{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-bottom:24px;
}

.userBtn{
    padding:10px 26px;
    border-radius:999px;
    cursor:pointer;
    background:rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.2s;
}

.userBtn:hover{ background:rgba(255,255,255,0.1); }

.userBtn.active{
    background:#22c55e;
    box-shadow:0 0 16px rgba(34,197,94,.6);
    border-color: #22c55e;
    font-weight: 600;
}

/* TABS */
.tabs{
    display:flex;
    justify-content:center;
    gap:12px;
    margin-bottom:26px;
    flex-wrap:wrap;
}

.tab{
    padding:10px 22px;
    border-radius:999px;
    cursor:pointer;
    background:rgba(255,255,255,0.06);
    transition: all 0.2s;
}

.tab.active{
    background:#6366f1;
    box-shadow:0 0 18px rgba(99,102,241,.6);
}

/* LAYOUT */
.container{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:24px;
}

.card{
    background:rgba(255,255,255,0.05);
    padding:24px;
    border-radius:20px;
    backdrop-filter:blur(14px);
    border: 1px solid rgba(255,255,255,0.05);
}

.row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
    background:rgba(255,255,255,0.04);
}

.inputGroup{display:flex;gap:8px;}

input,select{
    padding:10px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.1);
    background:rgba(0,0,0,0.2);
    color:white;
    outline: none;
}

button{
    border:none;
    padding:10px 20px;
    border-radius:10px;
    background:#6366f1;
    color:white;
    cursor:pointer;
    font-weight: 600;
    transition: 0.2s;
}

button:hover{ background:#4f46e5; }

/* TABLE & LIST STYLES */
.subjectCard{
    margin-top:24px;
    padding:20px;
    border-radius:18px;
    background:rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    overflow-x:auto;
}

.subjectTitle{
    font-weight:700;
    margin-bottom:16px;
    font-size:20px;
    color:#a5b4fc;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 8px;
}

table{
    width:100%;
    min-width:650px;
    border-collapse:separate;
    border-spacing:0 4px;
}

tr{ background:rgba(255,255,255,0.04); }
tr:hover{ background:rgba(255,255,255,0.07); }

th,td{ padding:14px; text-align:center; }
td:first-child{ text-align:left; font-weight:500; color: #e2e8f0; }
th{ color:#94a3b8; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

/* CHECKBOX */
input[type="checkbox"]{
    width:20px;
    height:20px;
    accent-color:#22c55e;
    cursor:pointer;
}

/* DELETE BUTTON */
.delBtn{
    background:rgba(239, 68, 68, 0.15);
    color:#f87171;
    padding:6px 12px;
    border-radius:8px;
    font-size:12px;
}
.delBtn:hover{ background:#ef4444; color:white; }

#saveStatus{
    text-align:center;
    font-size:13px;
    color:#64748b;
    margin-top:30px;
    font-family: monospace;
}

.hidden{display:none;}

@media(max-width:900px){
    .container{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<div class="app">
    <h1>ðŸ“˜ CA Study Tracker</h1>

    <div class="userSwitch">
        <div class="userBtn active" onclick="switchUser(event,'Swayam')">Swayam</div>
        <div class="userBtn" onclick="switchUser(event,'Nishika')">Nishika</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('hours')">Study Hours</div>
        <div class="tab" onclick="switchTab('completion')">Completion</div>
        <div class="tab" onclick="switchTab('revision')">Revision</div>
    </div>

    <div id="hoursTab">
        <div class="container">
            <div class="card">
                <h3>Enter Study Hours</h3>
                <div id="inputs"></div>
            </div>
            <div class="card">
                <h3>Study Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div id="completionTab" class="hidden">
        <div class="card">
            <h3>Add New Chapter</h3>
            <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
                <select id="completionSubject" style="min-width:100px;">
                    <option>AFM</option>
                    <option>FR</option>
                    <option>DT</option>
                    <option>IDT</option>
                    <option>Audit</option>
                </select>
                <input id="completionChapter" placeholder="Enter Chapter Name..." style="flex-grow:1;">
                <button onclick="addCompletion()">+ Add Chapter</button>
            </div>
            
            <div id="completionTables"></div>
        </div>
    </div>

    <div id="revisionTab" class="hidden">
        <div class="card">
            <h3>Add New Chapter for Revision</h3>
            <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
                <select id="revisionSubject" style="min-width:100px;">
                    <option>AFM</option>
                    <option>FR</option>
                    <option>DT</option>
                    <option>IDT</option>
                    <option>Audit</option>
                </select>
                <input id="revisionChapter" placeholder="Enter Chapter Name..." style="flex-grow:1;">
                <button onclick="addRevision()">+ Add Chapter</button>
            </div>

            <div id="revisionTables"></div>
        </div>
    </div>

    <div id="saveStatus">Connecting to Database...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyD-K-dXLSlLUqj_qir5PMtrxblzcq_PqY4",
  authDomain: "study-8c93f.firebaseapp.com",
  databaseURL: "https://study-8c93f-default-rtdb.firebaseio.com",
  projectId: "study-8c93f",
  storageBucket: "study-8c93f.firebasestorage.app",
  messagingSenderId: "467115751481",
  appId: "1:467115751481:web:54f32f6d2fb036378bf5e8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let appData = null;
let currentUser = "Swayam";
const subjects = ["AFM", "FR", "DT", "IDT", "Audit"];

// EMPTY DATA STRUCTURE
function createEmpty() {
    return {
        hours: { AFM: {total:0,completed:0}, FR: {total:0,completed:0}, DT: {total:0,completed:0}, IDT: {total:0,completed:0}, Audit: {total:0,completed:0} },
        completion: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] },
        revision: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] }
    };
}

// SAVE TO DB
function save() {
    if (appData) {
        set(ref(db, "caStudyTracker"), appData).then(() => {
            document.getElementById("saveStatus").innerText = "âœ” Data Synced: " + new Date().toLocaleTimeString();
            document.getElementById("saveStatus").style.color = "#4ade80";
        }).catch((e) => {
             document.getElementById("saveStatus").innerText = "âŒ Sync Error";
             document.getElementById("saveStatus").style.color = "#f87171";
        });
    }
}

// ================= GLOBAL WINDOW FUNCTIONS =================

window.switchUser = (e, user) => {
    currentUser = user;
    document.querySelectorAll(".userBtn").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    loadUser();
};

window.switchTab = (tab) => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('hoursTab').classList.add('hidden');
    document.getElementById('completionTab').classList.add('hidden');
    document.getElementById('revisionTab').classList.add('hidden');
    
    document.getElementById(tab + 'Tab').classList.remove('hidden');
    
    const tabs = document.querySelectorAll('.tab');
    if(tab==='hours') tabs[0].classList.add('active');
    if(tab==='completion') tabs[1].classList.add('active');
    if(tab==='revision') tabs[2].classList.add('active');
};

// ================= HOURS SECTION =================

const inputsDiv = document.getElementById("inputs");
subjects.forEach(subject => {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>${subject}</span><div class="inputGroup">
        <input type="number" placeholder="Total" id="${subject}-total">
        <input type="number" placeholder="Done" id="${subject}-completed">
    </div>`;
    inputsDiv.appendChild(row);
});

const chart = new Chart(document.getElementById('pieChart'), {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
    options: { plugins: { legend: { labels: { color: "white" } } }, cutout: "65%" }
});

function updateChart(shouldSave = true) {
    if (!appData) return;
    const baseColors = ["99,102,241", "34,197,94", "245,158,11", "239,68,68", "6,182,212"];
    const labels = [], data = [], colors = [];

    subjects.forEach((subject, i) => {
        const total = parseFloat(document.getElementById(`${subject}-total`).value) || 0;
        const completed = Math.min(parseFloat(document.getElementById(`${subject}-completed`).value) || 0, total);
        
        if (!appData[currentUser].hours) appData[currentUser].hours = {};
        appData[currentUser].hours[subject] = { total, completed };

        if (total > 0) {
            const rem = total - completed;
            if (completed > 0) { labels.push(subject + " âœ”"); data.push(completed); colors.push(`rgba(${baseColors[i]},1)`); }
            if (rem > 0) { labels.push(subject); data.push(rem); colors.push(`rgba(${baseColors[i]},.2)`); }
        }
    });

    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.data.datasets[0].backgroundColor = colors;
    chart.update();
    if (shouldSave) save();
}

document.querySelectorAll("#inputs input").forEach(i => i.addEventListener("input", () => updateChart(true)));

// ================= COMPLETION LOGIC =================

window.addCompletion = () => {
    const sub = document.getElementById("completionSubject").value;
    const chName = document.getElementById("completionChapter").value.trim();
    
    if (!chName) { alert("Please enter a chapter name"); return; }
    if (!appData) return;
    
    // Ensure array exists
    if(!appData[currentUser].completion[sub]) appData[currentUser].completion[sub] = [];
    
    // Add new chapter
    appData[currentUser].completion[sub].push({ name: chName, checks: [false, false, false] });
    
    document.getElementById("completionChapter").value = "";
    save();
    renderCompletion();
};

window.toggleCompletion = (sub, idx, box) => {
    appData[currentUser].completion[sub][idx].checks[box] = !appData[currentUser].completion[sub][idx].checks[box];
    save();
};

window.deleteCompletion = (sub, idx) => {
    if(confirm("Are you sure you want to delete this chapter?")) {
        appData[currentUser].completion[sub].splice(idx, 1);
        save();
        renderCompletion();
    }
};

function renderCompletion() {
    const tableContainer = document.getElementById("completionTables");
    tableContainer.innerHTML = "";
    const userData = appData[currentUser];
    
    // LOOP THROUGH SUBJECTS TO CREATE SEPARATE TABLES
    subjects.forEach(sub => {
        const list = userData.completion[sub] || [];
        
        if (list.length > 0) {
            let rows = list.map((c, i) => `
                <tr>
                    <td style="color:white; font-weight:600;">${c.name}</td>
                    <td><input type="checkbox" ${c.checks[0]?"checked":""} onchange="toggleCompletion('${sub}',${i},0)"></td>
                    <td><input type="checkbox" ${c.checks[1]?"checked":""} onchange="toggleCompletion('${sub}',${i},1)"></td>
                    <td><input type="checkbox" ${c.checks[2]?"checked":""} onchange="toggleCompletion('${sub}',${i},2)"></td>
                    <td><button class="delBtn" onclick="deleteCompletion('${sub}',${i})">Delete</button></td>
                </tr>
            `).join("");

            const card = document.createElement("div");
            card.className = "subjectCard";
            card.innerHTML = `
                <div class="subjectTitle">${sub}</div>
                <table>
                    <tr>
                        <th width="40%">Chapter Name</th>
                        <th width="15%">Lectures</th>
                        <th width="15%">Questions</th>
                        <th width="15%">MCQs</th>
                        <th width="15%">Action</th>
                    </tr>
                    ${rows}
                </table>`;
            tableContainer.appendChild(card);
        }
    });
}

// ================= REVISION LOGIC =================

window.addRevision = () => {
    const sub = document.getElementById("revisionSubject").value;
    const chName = document.getElementById("revisionChapter").value.trim();
    
    if (!chName) { alert("Please enter a chapter name"); return; }
    if (!appData) return;

    if(!appData[currentUser].revision[sub]) appData[currentUser].revision[sub] = [];
    appData[currentUser].revision[sub].push({ name: chName, checks: [false, false, false, false, false] });

    document.getElementById("revisionChapter").value = "";
    save();
    renderRevision();
};

window.toggleRevision = (sub, idx, box) => {
    appData[currentUser].revision[sub][idx].checks[box] = !appData[currentUser].revision[sub][idx].checks[box];
    save();
};

window.deleteRevision = (sub, idx) => {
    if(confirm("Delete this revision entry?")) {
        appData[currentUser].revision[sub].splice(idx, 1);
        save();
        renderRevision();
    }
};

function renderRevision() {
    const tableContainer = document.getElementById("revisionTables");
    tableContainer.innerHTML = "";
    const userData = appData[currentUser];

    // LOOP THROUGH SUBJECTS
    subjects.forEach(sub => {
        const list = userData.revision[sub] || [];
        
        if (list.length > 0) {
            let rows = list.map((c, i) => `
                <tr>
                    <td style="color:white; font-weight:600;">${c.name}</td>
                    <td><input type="checkbox" ${c.checks[0]?"checked":""} onchange="toggleRevision('${sub}',${i},0)"></td>
                    <td><input type="checkbox" ${c.checks[1]?"checked":""} onchange="toggleRevision('${sub}',${i},1)"></td>
                    <td><input type="checkbox" ${c.checks[2]?"checked":""} onchange="toggleRevision('${sub}',${i},2)"></td>
                    <td><input type="checkbox" ${c.checks[3]?"checked":""} onchange="toggleRevision('${sub}',${i},3)"></td>
                    <td><input type="checkbox" ${c.checks[4]?"checked":""} onchange="toggleRevision('${sub}',${i},4)"></td>
                    <td><button class="delBtn" onclick="deleteRevision('${sub}',${i})">Delete</button></td>
                </tr>
            `).join("");

            const card = document.createElement("div");
            card.className = "subjectCard";
            card.innerHTML = `
                <div class="subjectTitle">${sub}</div>
                <table>
                    <tr>
                        <th width="30%">Chapter</th>
                        <th>Rev 1</th>
                        <th>Rev 2</th>
                        <th>Rev 3</th>
                        <th>Rev 4</th>
                        <th>Rev 5</th>
                        <th>Action</th>
                    </tr>
                    ${rows}
                </table>`;
            tableContainer.appendChild(card);
        }
    });
}

function loadUser() {
    if (!appData) return;
    if (!appData[currentUser]) appData[currentUser] = createEmpty();
    const data = appData[currentUser];

    // SAFETY CHECKS
    if(!data.hours) data.hours = {};
    if(!data.completion) data.completion = { AFM: [], FR: [], DT: [], IDT: [], Audit: [] };
    if(!data.revision) data.revision = { AFM: [], FR: [], DT: [], IDT: [], Audit: [] };

    subjects.forEach(s => {
        document.getElementById(`${s}-total`).value = data.hours[s]?.total || "";
        document.getElementById(`${s}-completed`).value = data.hours[s]?.completed || "";
    });

    renderCompletion();
    renderRevision();
    updateChart(false);
}

// INIT
onValue(ref(db, "caStudyTracker"), (snap) => {
    const data = snap.val();
    if (data) {
        appData = data;
        document.getElementById("saveStatus").innerText = "âœ” Database Connected";
    } else {
        appData = { Swayam: createEmpty(), Nishika: createEmpty() };
        document.getElementById("saveStatus").innerText = "âœ” New Database Initialized";
    }
    loadUser();
});
</script>

</body>
</html>
