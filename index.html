import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyD-K-dXLSlLUqj_qir5PMtrxblzcq_PqY4",
    authDomain: "study-8c93f.firebaseapp.com",
    databaseURL: "https://study-8c93f-default-rtdb.firebaseio.com",
    projectId: "study-8c93f",
    storageBucket: "study-8c93f.firebasestorage.app",
    messagingSenderId: "467115751481",
    appId: "1:467115751481:web:54f32f6d2fb036378bf5e8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let appData = null; // Start as null to check if data is loaded
let currentUser = "Swayam";
let isInitialLoad = true;

function createEmpty() {
    return {
        hours: {},
        completion: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] },
        revision: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] }
    };
}

// Only save if appData has been populated from the database
function save() {
    if (appData && Object.keys(appData).length > 0) {
        set(ref(db, "caStudyTracker"), appData);
    }
}

function switchUser(e, user) {
    currentUser = user;
    document.querySelectorAll(".userBtn").forEach(b => b.classList.remove("active"));
    e.currentTarget.classList.add("active");
    loadUser();
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('hoursTab').classList.add('hidden');
    document.getElementById('completionTab').classList.add('hidden');
    document.getElementById('revisionTab').classList.add('hidden');

    if (tab === 'hours') {
        document.getElementById('hoursTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
    } else if (tab === 'completion') {
        document.getElementById('completionTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[1].classList.add('active');
    } else {
        document.getElementById('revisionTab').classList.remove('hidden');
        document.querySelectorAll('.tab')[2].classList.add('active');
    }
}

const subjects = ["AFM", "FR", "DT", "IDT", "Audit"];
const baseColors = ["99,102,241", "34,197,94", "245,158,11", "239,68,68", "6,182,212"];
const inputsDiv = document.getElementById("inputs");

subjects.forEach(subject => {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
        <span>${subject}</span>
        <div class="inputGroup">
            <input type="number" placeholder="Total" id="${subject}-total">
            <input type="number" placeholder="Done" id="${subject}-completed">
        </div>`;
    inputsDiv.appendChild(row);
});

const chart = new Chart(document.getElementById('pieChart'), {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
    options: { plugins: { legend: { labels: { color: "white" } } }, cutout: "65%" }
});

function loadUser() {
    if (!appData) return;
    if (!appData[currentUser]) appData[currentUser] = createEmpty();

    const data = appData[currentUser];
    subjects.forEach(subject => {
        document.getElementById(`${subject}-total`).value = data.hours[subject]?.total || "";
        document.getElementById(`${subject}-completed`).value = data.hours[subject]?.completed || "";
    });

    renderCompletion();
    renderRevision();
    updateChart(false); // Update UI without triggering a save
}

// Listener for inputs - only triggers if it's a manual user change
document.querySelectorAll("input").forEach(i => {
    i.addEventListener("input", () => updateChart(true));
});

function updateChart(shouldSave = true) {
    if (!appData) return;
    if (!appData[currentUser]) appData[currentUser] = createEmpty();

    const labels = [];
    const data = [];
    const colors = [];

    subjects.forEach((subject, i) => {
        const total = parseFloat(document.getElementById(`${subject}-total`).value) || 0;
        const completed = Math.min(parseFloat(document.getElementById(`${subject}-completed`).value) || 0, total);

        appData[currentUser].hours[subject] = { total, completed };

        if (total > 0) {
            const remaining = total - completed;
            if (completed > 0) {
                labels.push(subject + " âœ”");
                data.push(completed);
                colors.push(`rgba(${baseColors[i]},1)`);
            }
            if (remaining > 0) {
                labels.push(subject);
                data.push(remaining);
                colors.push(`rgba(${baseColors[i]},.2)`);
            }
        }
    });

    if (shouldSave) save();

    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.data.datasets[0].backgroundColor = colors;
    chart.update();
}

function addCompletion() {
    const subject = document.getElementById("completionSubject").value;
    const chapter = document.getElementById("completionChapter").value.trim();
    if (!chapter || !appData) return;

    appData[currentUser].completion[subject].push({ name: chapter, checks: [false, false, false] });
    document.getElementById("completionChapter").value = "";
    save();
    renderCompletion();
}

function renderCompletion() {
    const container = document.getElementById("completionTables");
    container.innerHTML = "";
    const userData = appData[currentUser];

    subjects.forEach(subject => {
        if (!userData.completion[subject] || userData.completion[subject].length === 0) return;
        let rows = "";
        userData.completion[subject].forEach((ch, index) => {
            rows += `
            <tr>
                <td>${ch.name}</td>
                ${ch.checks.map((val, i) => `
                <td><input type="checkbox" ${val ? "checked" : ""} 
                onchange="toggleCompletion('${subject}',${index},${i})"></td>`).join("")}
            </tr>`;
        });

        const card = document.createElement("div");
        card.className = "subjectCard";
        card.innerHTML = `<div class="subjectTitle">${subject}</div><table><tr><th>Chapter</th><th>Chapter</th><th>Questions</th><th>MCQs</th></tr>${rows}</table>`;
        container.appendChild(card);
    });
}

function toggleCompletion(subject, index, box) {
    appData[currentUser].completion[subject][index].checks[box] = !appData[currentUser].completion[subject][index].checks[box];
    save();
}

function addRevision() {
    const subject = document.getElementById("revisionSubject").value;
    const chapter = document.getElementById("revisionChapter").value.trim();
    if (!chapter || !appData) return;

    appData[currentUser].revision[subject].push({ name: chapter, checks: [false, false, false, false, false] });
    document.getElementById("revisionChapter").value = "";
    save();
    renderRevision();
}

function renderRevision() {
    const container = document.getElementById("revisionTables");
    container.innerHTML = "";
    const userData = appData[currentUser];

    subjects.forEach(subject => {
        if (!userData.revision[subject] || userData.revision[subject].length === 0) return;
        let rows = "";
        userData.revision[subject].forEach((ch, index) => {
            rows += `
            <tr>
                <td>${ch.name}</td>
                ${ch.checks.map((val, i) => `
                <td><input type="checkbox" ${val ? "checked" : ""} 
                onchange="toggleRevision('${subject}',${index},${i})"></td>`).join("")}
            </tr>`;
        });

        const card = document.createElement("div");
        card.className = "subjectCard";
        card.innerHTML = `<div class="subjectTitle">${subject}</div><table><tr><th>Chapter</th><th>R1</th><th>R2</th><th>R3</th><th>R4</th><th>R5</th></tr>${rows}</table>`;
        container.appendChild(card);
    });
}

function toggleRevision(subject, index, box) {
    appData[currentUser].revision[subject][index].checks[box] = !appData[currentUser].revision[subject][index].checks[box];
    save();
}

window.switchUser = switchUser;
window.switchTab = switchTab;
window.addCompletion = addCompletion;
window.addRevision = addRevision;
window.toggleCompletion = toggleCompletion;
window.toggleRevision = toggleRevision;

// REAL-TIME SYNC
onValue(ref(db, "caStudyTracker"), (snapshot) => {
    const data = snapshot.val();
    if (data) {
        appData = data;
    } else {
        // Initialize if DB is completely empty for the first time ever
        appData = { Swayam: createEmpty(), Nishika: createEmpty() };
    }
    loadUser();
});
