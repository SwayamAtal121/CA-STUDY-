
<!DOCTYPE html>
<html>
<head>
  <title>CA Couple Study App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      margin: 0;
      padding: 20px;
    }
    h1 {text-align:center;}
    .user-buttons button {
      margin:5px;
      padding:10px 20px;
      border:none;
      border-radius:20px;
      cursor:pointer;
    }
    .active {background:#22c55e;}
    .container {display:flex; gap:20px; flex-wrap:wrap;}
    .card {
      background:#1e293b;
      padding:20px;
      border-radius:12px;
      flex:1;
      min-width:300px;
    }
    input {width:70px;}
  </style>
</head>

<body>

<h1>CA Couple Study Tracker</h1>

<div class="user-buttons">
  <button onclick="switchUser('Swayam')" id="btn-Swayam">Swayam</button>
  <button onclick="switchUser('Nishika')" id="btn-Nishika">Nishika</button>
</div>

<div class="container">

<div class="card">
<h3>Study Hours</h3>
<div id="inputs"></div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

</div>

<script>

const supabase = window.supabase.createClient(
"https://zuzbgxcddlkmsdhdepsy.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1emJneGNkZGxrbXNkaGRlcHN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NTg2NjIsImV4cCI6MjA4NjAzNDY2Mn0.TjNstlUbG6I7KfkxkNpPvc-D50U-qqUmUg0f6ZpV-L8"
);

const subjects = ["AFM","FR","DT","IDT","Audit"];
let currentUser = "Swayam";
let userData = {};

subjects.forEach(sub => {
  const div = document.createElement("div");
  div.innerHTML = `
    ${sub} 
    Total <input id="${sub}-total" type="number">
    Done <input id="${sub}-done" type="number"><br><br>
  `;
  document.getElementById("inputs").appendChild(div);
});

const ctx = document.getElementById("chart");

const chart = new Chart(ctx, {
  type: 'doughnut',
  data: {labels:[], datasets:[{data:[]}]},
});

async function loadData(){

const { data } = await supabase
.from("study_data")
.select("*")
.eq("user_name", currentUser)
.single();

if(data){
userData = data.data;
}else{
userData = {};
subjects.forEach(s=>userData[s]={total:0,done:0});

await supabase.from("study_data").insert({
user_name: currentUser,
data: userData
});
}

populateUI();
}

function populateUI(){

subjects.forEach(sub=>{
document.getElementById(`${sub}-total`).value = userData[sub]?.total || "";
document.getElementById(`${sub}-done`).value = userData[sub]?.done || "";
});

updateChart();
}

async function save(){

subjects.forEach(sub=>{
userData[sub]={
total: Number(document.getElementById(`${sub}-total`).value)||0,
done: Number(document.getElementById(`${sub}-done`).value)||0
};
});

await supabase
.from("study_data")
.update({data:userData})
.eq("user_name", currentUser);

updateChart();
}

function updateChart(){

let labels=[];
let values=[];

subjects.forEach(sub=>{
let t=userData[sub]?.total||0;
let d=userData[sub]?.done||0;

if(t>0){
labels.push(sub+" done");
values.push(d);
labels.push(sub+" left");
values.push(t-d);
}
});

chart.data.labels=labels;
chart.data.datasets[0].data=values;
chart.update();
}

document.addEventListener("input", ()=>save());

function switchUser(user){
currentUser=user;
document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
document.getElementById("btn-"+user).classList.add("active");
loadData();
}

supabase.channel('changes')
.on('postgres_changes',{event:'UPDATE',schema:'public',table:'study_data'},payload=>{
if(payload.new.user_name===currentUser){
userData=payload.new.data;
populateUI();
}
})
.subscribe();

switchUser("Swayam");

</script>

</body>
</html>
