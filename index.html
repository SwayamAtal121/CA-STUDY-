<!DOCTYPE html>
<html>
<head>
<title>CA Study Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}

body{
font-family:'Inter',sans-serif;
margin:0;
background:linear-gradient(135deg,#020617,#0f172a);
color:white;
}

.app{
max-width:1350px;
margin:auto;
padding:30px 18px;
}

h1{text-align:center;margin-bottom:18px;}

.userSwitch{
display:flex;
justify-content:center;
gap:14px;
margin-bottom:24px;
}

.userBtn{
padding:10px 26px;
border-radius:999px;
cursor:pointer;
background:rgba(255,255,255,0.06);
}

.userBtn.active{
background:#22c55e;
box-shadow:0 0 16px rgba(34,197,94,.6);
}

.tabs{
display:flex;
justify-content:center;
gap:12px;
margin-bottom:26px;
flex-wrap:wrap;
}

.tab{
padding:10px 22px;
border-radius:999px;
cursor:pointer;
background:rgba(255,255,255,0.06);
}

.tab.active{
background:#6366f1;
box-shadow:0 0 18px rgba(99,102,241,.6);
}

.container{
display:grid;
grid-template-columns:1fr 1fr;
gap:24px;
}

.card{
background:rgba(255,255,255,0.05);
padding:24px;
border-radius:20px;
backdrop-filter:blur(14px);
}

.row{
display:flex;
justify-content:space-between;
align-items:center;
padding:12px;
border-radius:12px;
margin-bottom:10px;
background:rgba(255,255,255,0.04);
}

.inputGroup{display:flex;gap:8px;}

input,select{
padding:8px;
border-radius:10px;
border:none;
background:rgba(255,255,255,0.12);
color:white;
}

button{
border:none;
padding:9px 16px;
border-radius:10px;
background:#6366f1;
color:white;
cursor:pointer;
}

.delBtn{
background:rgba(239, 68, 68, 0.2);
color:#f87171;
padding:4px 10px;
border-radius:6px;
font-size:12px;
transition: 0.2s;
}

.delBtn:hover{
background:#ef4444;
color:white;
}

.subjectCard{
margin-top:24px;
padding:18px;
border-radius:18px;
background:rgba(255,255,255,0.04);
overflow-x:auto;
}

.subjectTitle{
font-weight:600;
margin-bottom:12px;
font-size:18px;
color:#a5b4fc;
}

table{
width:100%;
min-width:650px;
border-collapse:separate;
border-spacing:0 8px;
}

tr{background:rgba(255,255,255,0.05);}

th,td{
padding:12px;
text-align:center;
}

td:first-child{text-align:left;font-weight:500;}
th{color:#c7d2fe;}

input[type="checkbox"]{
width:18px;
height:18px;
accent-color:#6366f1;
cursor:pointer;
}

#saveStatus{
text-align:center;
font-size:12px;
color:#94a3b8;
margin-top:20px;
}

.hidden{display:none;}

@media(max-width:900px){
.container{grid-template-columns:1fr;}
}
</style>
</head>

<body>

<div class="app">
    <h1>ðŸ“˜ CA Study Tracker</h1>

    <div class="userSwitch">
        <div class="userBtn active" onclick="switchUser(event,'Swayam')">Swayam</div>
        <div class="userBtn" onclick="switchUser(event,'Nishika')">Nishika</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('hours')">Study Hours</div>
        <div class="tab" onclick="switchTab('completion')">Completion</div>
        <div class="tab" onclick="switchTab('revision')">Revision</div>
    </div>

    <div id="hoursTab">
        <div class="container">
            <div class="card">
                <h3>Enter Study Hours</h3>
                <div id="inputs"></div>
            </div>
            <div class="card">
                <h3>Study Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div id="completionTab" class="hidden">
        <div class="card">
            <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
                <select id="completionSubject">
                    <option>AFM</option><option>FR</option><option>DT</option>
                    <option>IDT</option><option>Audit</option>
                </select>
                <input id="completionChapter" placeholder="Chapter name">
                <button onclick="addCompletion()">Add Chapter</button>
            </div>
            <div id="completionTables"></div>
        </div>
    </div>

    <div id="revisionTab" class="hidden">
        <div class="card">
            <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
                <select id="revisionSubject">
                    <option>AFM</option><option>FR</option><option>DT</option>
                    <option>IDT</option><option>Audit</option>
                </select>
                <input id="revisionChapter" placeholder="Chapter name">
                <button onclick="addRevision()">Add Chapter</button>
            </div>
            <div id="revisionTables"></div>
        </div>
    </div>

    <div id="saveStatus">Connecting...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD-K-dXLSlLUqj_qir5PMtrxblzcq_PqY4",
  authDomain: "study-8c93f.firebaseapp.com",
  databaseURL: "https://study-8c93f-default-rtdb.firebaseio.com",
  projectId: "study-8c93f",
  storageBucket: "study-8c93f.firebasestorage.app",
  messagingSenderId: "467115751481",
  appId: "1:467115751481:web:54f32f6d2fb036378bf5e8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let appData = null;
let currentUser = "Swayam";
const subjects = ["AFM", "FR", "DT", "IDT", "Audit"];

function createEmpty() {
    return {
        hours: {},
        completion: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] },
        revision: { AFM: [], FR: [], DT: [], IDT: [], Audit: [] }
    };
}

function save() {
    if (appData) {
        set(ref(db, "caStudyTracker"), appData).then(() => {
            document.getElementById("saveStatus").innerText = "Last Saved: " + new Date().toLocaleTimeString();
        });
    }
}

// Global functions for buttons
window.switchUser = (e, user) => {
    currentUser = user;
    document.querySelectorAll(".userBtn").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    loadUser();
};

window.switchTab = (tab) => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('hoursTab').classList.add('hidden');
    document.getElementById('completionTab').classList.add('hidden');
    document.getElementById('revisionTab').classList.add('hidden');
    document.getElementById(tab + 'Tab').classList.remove('hidden');
    const tabs = document.querySelectorAll('.tab');
    if(tab==='hours') tabs[0].classList.add('active');
    if(tab==='completion') tabs[1].classList.add('active');
    if(tab==='revision') tabs[2].classList.add('active');
};

// Setup Hours Inputs
const inputsDiv = document.getElementById("inputs");
subjects.forEach(subject => {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>${subject}</span><div class="inputGroup">
        <input type="number" placeholder="Total" id="${subject}-total">
        <input type="number" placeholder="Done" id="${subject}-completed">
    </div>`;
    inputsDiv.appendChild(row);
});

const chart = new Chart(document.getElementById('pieChart'), {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
    options: { plugins: { legend: { labels: { color: "white" } } }, cutout: "65%" }
});

function updateChart(shouldSave = true) {
    if (!appData) return;
    const baseColors = ["99,102,241", "34,197,94", "245,158,11", "239,68,68", "6,182,212"];
    const labels = [], data = [], colors = [];

    subjects.forEach((subject, i) => {
        const total = parseFloat(document.getElementById(`${subject}-total`).value) || 0;
        const completed = Math.min(parseFloat(document.getElementById(`${subject}-completed`).value) || 0, total);
        appData[currentUser].hours[subject] = { total, completed };

        if (total > 0) {
            const rem = total - completed;
            if (completed > 0) { labels.push(subject + " âœ”"); data.push(completed); colors.push(`rgba(${baseColors[i]},1)`); }
            if (rem > 0) { labels.push(subject); data.push(rem); colors.push(`rgba(${baseColors[i]},.2)`); }
        }
    });

    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.data.datasets[0].backgroundColor = colors;
    chart.update();
    if (shouldSave) save();
}

document.querySelectorAll("#inputs input").forEach(i => i.addEventListener("input", () => updateChart(true)));

// COMPLETION LOGIC
window.addCompletion = () => {
    const sub = document.getElementById("completionSubject").value;
    const ch = document.getElementById("completionChapter").value.trim();
    if (!ch || !appData) return;
    
    if (!appData[currentUser].completion[sub]) appData[currentUser].completion[sub] = [];
    appData[currentUser].completion[sub].push({ name: ch, checks: [false, false, false] });
    
    document.getElementById("completionChapter").value = "";
    save();
    renderCompletion();
};

window.toggleCompletion = (sub, idx, box) => {
    appData[currentUser].completion[sub][idx].checks[box] = !appData[currentUser].completion[sub][idx].checks[box];
    save();
};

window.deleteCompletion = (sub, idx) => {
    if(confirm("Delete this chapter?")) {
        appData[currentUser].completion[sub].splice(idx, 1);
        save();
        renderCompletion();
    }
};

function renderCompletion() {
    const div = document.getElementById("completionTables");
    div.innerHTML = "";
    const userData = appData[currentUser];
    subjects.forEach(sub => {
        const list = userData.completion[sub] || [];
        if (list.length === 0) return;
        let rows = "";
        list.forEach((c, i) => {
            rows += `<tr>
                <td>${c.name}</td>
                ${c.checks.map((v, b) => `<td><input type="checkbox" ${v?"checked":""} onchange="toggleCompletion('${sub}',${i},${b})"></td>`).join("")}
                <td><button class="delBtn" onclick="deleteCompletion('${sub}',${i})">Delete</button></td>
            </tr>`;
        });
        const card = document.createElement("div");
        card.className = "subjectCard";
        card.innerHTML = `<div class="subjectTitle">${sub}</div>
            <table>
                <tr><th>Chapter</th><th>Lectures Done</th><th>Questions Done</th><th>MCQ's Done</th><th>Action</th></tr>
                ${rows}
            </table>`;
        div.appendChild(card);
    });
}

// REVISION LOGIC
window.addRevision = () => {
    const sub = document.getElementById("revisionSubject").value;
    const ch = document.getElementById("revisionChapter").value.trim();
    if (!ch || !appData) return;
    
    if (!appData[currentUser].revision[sub]) appData[currentUser].revision[sub] = [];
    appData[currentUser].revision[sub].push({ name: ch, checks: [false, false, false, false, false] });
    
    document.getElementById("revisionChapter").value = "";
    save();
    renderRevision();
};

window.toggleRevision = (sub, idx, box) => {
    appData[currentUser].revision[sub][idx].checks[box] = !appData[currentUser].revision[sub][idx].checks[box];
    save();
};

window.deleteRevision = (sub, idx) => {
    if(confirm("Delete this chapter?")) {
        appData[currentUser].revision[sub].splice(idx, 1);
        save();
        renderRevision();
    }
};

function renderRevision() {
    const div = document.getElementById("revisionTables");
    div.innerHTML = "";
    const userData = appData[currentUser];
    subjects.forEach(sub => {
        const list = userData.revision[sub] || [];
        if (list.length === 0) return;
        let rows = "";
        list.forEach((c, i) => {
            rows += `<tr>
                <td>${c.name}</td>
                ${c.checks.map((v, b) => `<td><input type="checkbox" ${v?"checked":""} onchange="toggleRevision('${sub}',${i},${b})"></td>`).join("")}
                <td><button class="delBtn" onclick="deleteRevision('${sub}',${i})">Delete</button></td>
            </tr>`;
        });
        const card = document.createElement("div");
        card.className = "subjectCard";
        card.innerHTML = `<div class="subjectTitle">${sub}</div>
            <table>
                <tr><th>Chapter</th><th>Rev 1</th><th>Rev 2</th><th>Rev 3</th><th>Rev 4</th><th>Rev 5</th><th>Action</th></tr>
                ${rows}
            </table>`;
        div.appendChild(card);
    });
}

function loadUser() {
    if (!appData) return;
    if (!appData[currentUser]) appData[currentUser] = createEmpty();
    const data = appData[currentUser];
    subjects.forEach(s => {
        document.getElementById(`${s}-total`).value = data.hours[s]?.total || "";
        document.getElementById(`${s}-completed`).value = data.hours[s]?.completed || "";
    });
    renderCompletion();
    renderRevision();
    updateChart(false);
}

// Sync with Firebase
onValue(ref(db, "caStudyTracker"), (snap) => {
    const data = snap.val();
    if (data) {
        appData = data;
    } else {
        appData = { Swayam: createEmpty(), Nishika: createEmpty() };
    }
    loadUser();
});
</script>

</body>
</html>
